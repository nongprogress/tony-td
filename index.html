<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TONY TD ‚Äî v1.6 Variety Update</title>
<style>
  :root{--bg:#0b1220;--ink:#e2e8f0;--mut:#94a3b8;--card:#0f172a;--line:#334155;--pri:#22d3ee;--acc:#60a5fa;--ok:#22c55e;--bad:#ef4444;--gold:#facc15}
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; overflow:hidden; background:var(--bg);}
  body{color:var(--ink);font:14px system-ui,Inter,Segoe UI,Roboto;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
  .game-container{width:100vw;height:100vh;display:flex;flex-direction:column;position:relative}
  #world{width:100%;flex-grow:1;position:relative;overflow:hidden;touch-action:manipulation;cursor:crosshair;background-size:cover;background-position:center}
  .tile{position:absolute;width:46px;height:46px;border-radius:8px}
  .tile.path{background:rgba(11,30,52,0.65);border:1px solid #10335d}
  .tile.build{background:rgba(12,20,36,0.55);border:1px dashed #1f3861}
  .base{position:absolute;width:42px;height:42px;border-radius:10px;background:#1f2937;border:2px solid #94a3b8}
  #hud{position:absolute;inset:0;pointer-events:none;padding:8px;display:flex;flex-direction:column;justify-content:space-between}
  .hud-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;pointer-events:auto}
  .hud-row.top{justify-content:flex-start}
  .hud-row.bottom{justify-content:center}
  @media (orientation: landscape) and (min-height: 400px) {
    #hud{flex-direction:row}
    .hud-row.bottom{flex-direction:column;justify-content:flex-start;max-width:220px}
  }
  .btn{background:var(--pri);color:#001b2a;border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer;transition:transform .1s, background-color .2s}
  .btn:hover{transform:translateY(-1px)}
  .btn.ghost{background:rgba(15,23,42,0.8);border:1px solid var(--line);color:var(--ink)}
  .btn.small{padding:6px 10px}
  .btn.warn{background:#f59e0b;color:#0b1220}
  .btn.spell{background:#ef4444;color:#fff}
  .badge{background:rgba(15,23,42,0.85);border:1px solid var(--line);padding:6px 10px;border-radius:10px;color:var(--mut);display:flex;gap:6px;align-items:center}
  .sprite{position:absolute;background-size:contain;background-position:center;background-repeat:no-repeat}
  .tower.sprite{width:40px;height:40px}
  .enemy.sprite{width:28px;height:28px}
  .health-bar{position:absolute;top:-8px;left:0;width:100%;height:4px;background:#450a0a;border-radius:2px}
  .health-bar-inner{height:100%;background:#dc2626;border-radius:2px;transition:width .2s}
  .bullet{position:absolute;width:6px;height:6px;border-radius:50%;background:#60a5fa}
  .bullet.frost{background:#a5f3fc}
  .bullet.missile{width:10px;height:10px;background:#fb923c;border-radius:4px}
  .explosion{position:absolute;width:60px;height:60px;border-radius:50%;background:rgba(251,146,60,.7);transform:scale(0);animation:explode .3s ease-out}
  @keyframes explode{0%{transform:scale(0);opacity:1}100%{transform:scale(1);opacity:0}}
  .meteor-impact{position:absolute;width:100px;height:100px;border-radius:50%;background:rgba(239,68,68,.8);transform:scale(0);animation:explode .4s ease-out}
  .range-indicator{position:absolute;border:2px dashed var(--pri);border-radius:50%;pointer-events:none;opacity:0.6;transition:all .2s}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .panel{border:1px solid var(--line);border-radius:10px;padding:8px;background:#0b1220;margin-bottom:8px}
  .kv{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed var(--line);color:var(--mut)}
  .list{max-height:180px;overflow:auto;border:1px dashed var(--line);border-radius:8px;padding:6px;background:#0b1220}
  .inv{display:flex;gap:6px;flex-wrap:wrap}
  .tag{border:1px solid var(--line);padding:6px 8px;border-radius:999px;background:#0b1220;color:var(--mut)}
  .highlight{outline:3px solid var(--pri);box-shadow:0 0 15px var(--pri)}
  .note{color:#93c5fd;font-size:12px}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:var(--pri);color:#001b2a;padding:8px 12px;border-radius:10px;font-weight:800;z-index:9999}
  /* Modal generic */
  .modal{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:opacity .2s,visibility .2s}
  .modal.show{opacity:1;visibility:visible}
  .modal .backdrop{position:absolute;inset:0;background:rgba(2,6,23,.8);backdrop-filter:blur(3px)}
  .modal .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;width:92%;max-width:460px;max-height:85vh;overflow:auto}
  .modal h3{margin:0 0 6px 0}
</style>
</head>
<body>
<div class="game-container">
  <div id="world"></div>
  <div id="hud">
    <div class="hud-row top">
      <div class="badge">Stage: <b id="stage">1</b></div>
      <div class="badge">Wave: <b id="wave">1</b></div>
      <div class="badge">HP: <b id="hp">20</b></div>
      <div class="badge">‡∏ó‡∏≠‡∏á: <b id="gold">180</b></div>
      <button id="btnStart" class="btn small">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏° Wave</button>
      <button id="btnPause" class="btn small ghost">‚è∏ Pause</button>
      <button id="btnShop" class="btn small warn">üõí Shop</button>
      <button id="btnResearch" class="btn small ghost">üî¨ Research</button>
    </div>
    <div class="hud-row bottom">
      <select id="selTower">
        <option value="gun">‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏∑‡∏ô (50G)</option>
        <option value="sniper">‡∏™‡πÑ‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå (80G)</option>
        <option value="frost">‡∏ü‡∏£‡∏≠‡∏™‡∏ï‡πå‡∏™‡πÇ‡∏•‡∏ß‡πå (60G)</option>
        <option value="missile">‡∏õ‡πâ‡∏≠‡∏°‡∏à‡∏£‡∏ß‡∏î (100G)</option>
      </select>
      <button id="btnPlace" class="btn small">‡∏ß‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏°</button>
      <button id="btnSell" class="btn small ghost">‡∏Ç‡∏≤‡∏¢ (+60%)</button>
      <button id="btnMeteor" class="btn small spell">‚òÑÔ∏è Meteor (120G)</button>
    </div>
  </div>
</div>

<!-- SHOP MODAL -->
<div id="shop" class="modal">
  <div class="backdrop"></div>
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h3>üõí Item Shop</h3>
      <button class="btn small ghost" id="shopClose">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="panel">
      <div class="kv"><span>üí£ Bomb (60G)</span><span><button class="btn small" id="buyBomb">‡∏ã‡∏∑‡πâ‡∏≠</button></span></div>
      <div class="kv"><span>‚ùÑÔ∏è Freeze (70G)</span><span><button class="btn small" id="buyFreeze">‡∏ã‡∏∑‡πâ‡∏≠</button></span></div>
      <div class="kv"><span>‚öôÔ∏è Overclock (90G)</span><span><button class="btn small" id="buyOC">‡∏ã‡∏∑‡πâ‡∏≠</button></span></div>
      <div class="kv"><span>üîÅ Reroll Items (15G)</span><span><button class="btn small ghost" id="reroll">Reroll</button></span></div>
    </div>
    <div class="panel">
      <h3 class="section" style="margin:0 0 6px 0">‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ</h3>
      <div id="bag" class="inv"></div>
      <div class="note">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: Bomb/Freeze ‡πÅ‡∏ï‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏≤‡∏° ‚Ä¢ Overclock ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ö‡∏±‡∏ü‡∏õ‡πâ‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)</div>
    </div>
  </div>
</div>

<!-- RESEARCH MODAL -->
<div id="lab" class="modal">
  <div class="backdrop"></div>
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h3>üî¨ Research Lab</h3>
      <button class="btn small ghost" id="labClose">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="panel">
      <div class="kv"><span>Ballistics I: +10% DMG (120G)</span><span><button class="btn small" data-r="ball1">‡∏ß‡∏¥‡∏à‡∏±‡∏¢</button></span></div>
      <div class="kv"><span>Ballistics II: +10% DMG (220G)</span><span><button class="btn small" data-r="ball2">‡∏ß‡∏¥‡∏à‡∏±‡∏¢</button></span></div>
      <div class="kv"><span>Finance I: +2G/100G ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (100G)</span><span><button class="btn small" data-r="fin1">‡∏ß‡∏¥‡∏à‡∏±‡∏¢</button></span></div>
      <div class="kv"><span>Finance II: +3G/100G ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (200G)</span><span><button class="btn small" data-r="fin2">‡∏ß‡∏¥‡∏à‡∏±‡∏¢</button></span></div>
      <div class="kv"><span>Arcana I: Meteor +20 DMG (120G)</span><span><button class="btn small" data-r="arc1">‡∏ß‡∏¥‡∏à‡∏±‡∏¢</button></span></div>
      <div class="kv"><span>Arcana II: Meteor +30 DMG (240G)</span><span><button class="btn small" data-r="arc2">‡∏ß‡∏¥‡∏à‡∏±‡∏¢</button></span></div>
    </div>
    <div class="panel">
      <div class="note">‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏•‡∏≠‡∏î‡∏à‡∏ô‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</div>
    </div>
  </div>
</div>

<!-- OVERLAY: START -->
<div id="overlay" class="modal show">
  <div class="backdrop"></div>
  <div class="card">
    <h3>TONY TD ‚Äî Variety Update</h3>
    <div class="panel">
      <div class="kv"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</span>
        <span>
          <select id="selDiff">
            <option value="easy">Easy</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard</option>
          </select>
        </span>
      </div>
      <div class="kv"><span>Endless Mode</span>
        <span><label><input type="checkbox" id="chkEndless"> ‡πÄ‡∏õ‡∏¥‡∏î</label></span>
      </div>
      <div class="note">* Endless ‡∏à‡∏∞‡∏ß‡∏ô Stage ‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡∏ô‡πâ‡∏≠‡∏¢</div>
    </div>
    <div class="row" style="justify-content:center">
      <button id="ovrGo" class="btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const world=$("world");
  const ui={stage:$("stage"),wave:$("wave"),hp:$("hp"),gold:$("gold"),bag:$("bag")};
  const RAF=window.requestAnimationFrame||(f=>setTimeout(()=>f(performance.now()),16));
  function el(t,c){const d=document.createElement(t); if(c) d.className=c; return d;}
  function tip(s){const d=el('div','toast'); d.textContent=s; document.body.appendChild(d); setTimeout(()=>d.remove(),1200);}
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const dist=(ax,ay,bx,by)=>Math.hypot(ax-bx,ay-by);

  // ---------- Assets (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ) ----------
  const assets = {
    tower:{ gun:'https://placehold.co/40x40/22c55e/FFFFFF?text=G', sniper:'https://placehold.co/40x40/38bdf8/FFFFFF?text=S', frost:'https://placehold.co/40x40/a5f3fc/000/fff?text=F', missile:'https://placehold.co/40x40/f97316/FFFFFF?text=M' },
    enemy:{ runner:'https://placehold.co/28x28/ef4444/fff?text=R', brute:'https://placehold.co/28x28/8b5cf6/fff?text=B', flyer:'https://placehold.co/28x28/f59e0b/000?text=F', bandit:'https://placehold.co/28x28/a16207/fff?text=T', boss:'https://placehold.co/40x40/ef4444/fff?text=BOSS' },
    bg:{ grass:'https://placehold.co/1200x800/0a0f1a/334155?text=Grassland', desert:'https://placehold.co/1200x800/362b11/facc15?text=Desert', city:'https://placehold.co/1200x800/0c111b/7aa2?text=City' }
  };

  // ---------- Game State ----------
  const S={
    stage:1, wave:1, baseHP:20, gold:180, running:false, paused:false, last:0,
    tiles:[], path:[], start:null, goal:null, towers:[], enemies:[], bullets:[],
    selected:null, mode:null, rangeIndicator:null,
    items:{bomb:0,freeze:0,oc:0}, research:{ball1:false,ball2:false,fin1:false,fin2:false,arc1:false,arc2:false},
    difficulty:'normal', endless:false, difficultyScale:1.0, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏ô‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏ô‡∏î‡πà‡∏≤‡∏ô
  };

  // ---------- Difficulty Config ----------
  const DIFF={
    easy:   {hp:22, gold:220, enemyHP:0.9, reward:1.1},
    normal: {hp:20, gold:180, enemyHP:1.0, reward:1.0},
    hard:   {hp:18, gold:150, enemyHP:1.15, reward:0.9}
  };

  // ---------- Stages: path & modifiers ----------
  const GRID={rows:9, cols:16, size:46};
  const STAGES=[
    { name:'Grass', bg:assets.bg.grass, mod:{flyer:1.0,speed:1.0}, path:[[4,0],[4,1],[4,2],[4,3],[3,3],[2,3],[2,4],[2,5],[3,5],[4,5],[5,5],[6,5],[6,6],[6,7],[5,7],[4,7],[3,7],[3,8],[3,9],[4,9],[5,9],[6,9],[7,9],[7,10],[7,11],[6,11],[5,11],[4,11],[3,11],[2,11],[2,12],[2,13],[3,13],[4,13],[5,13],[5,14],[5,15]] },
    { name:'Desert', bg:assets.bg.desert, mod:{flyer:0.8,speed:1.1}, path:[[1,0],[1,1],[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],[7,3],[7,4],[6,4],[5,4],[4,4],[3,4],[2,4],[1,4],[1,5],[1,6],[2,6],[3,6],[4,6],[5,6],[6,6],[7,6],[7,7],[7,8],[6,8],[5,8],[4,8],[3,8],[2,8],[1,8],[1,9],[1,10],[2,10],[3,10],[4,10],[5,10],[6,10],[7,10],[7,11],[7,12],[6,12],[5,12],[4,12],[4,13],[4,14],[4,15]] },
    { name:'City', bg:assets.bg.city, mod:{flyer:1.3,speed:0.95}, path:[[0,1],[1,1],[2,1],[3,1],[4,1],[5,1],[5,2],[5,3],[4,3],[3,3],[3,4],[3,5],[4,5],[5,5],[6,5],[7,5],[7,6],[7,7],[6,7],[5,7],[4,7],[4,8],[4,9],[5,9],[6,9],[7,9],[7,10],[7,11],[6,11],[5,11],[4,11],[3,11],[2,11],[1,11],[1,12],[1,13],[2,13],[3,13],[4,13],[5,13],[6,13],[6,14],[6,15]] }
  ];

  // ---------- Towers / Enemies ----------
  const DEF_TOWER={
    gun:{name:'‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏∑‡∏ô', cost:50, dmg:6, rng:120, rof:1.6, aa:true, slow:0, splash:0},
    sniper:{name:'‡∏™‡πÑ‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå', cost:80, dmg:22, rng:240, rof:0.55, aa:true, slow:0, splash:0},
    frost:{name:'‡∏ü‡∏£‡∏≠‡∏™‡∏ï‡πå', cost:60, dmg:5, rng:130, rof:1.0, aa:false, slow:0.45, splash:0},
    missile:{name:'‡∏õ‡πâ‡∏≠‡∏°‡∏à‡∏£‡∏ß‡∏î', cost:100, dmg:18, rng:180, rof:0.8, aa:false, slow:0, splash:28}
  };
  const DEF_ENEMY={
    runner:(w)=>({hp:(12+w*1), spd:85, tag:'ground', cls:'runner'}),
    brute:(w)=>({hp:(42+w*5), spd:45, tag:'ground', cls:'brute'}),
    flyer:(w)=>({hp:(16+w*2), spd:78, tag:'air', cls:'flyer'}),
    bandit:(w)=>({hp:(10+w*1), spd:125, tag:'ground', cls:'bandit'}),
    boss:(w)=>({hp:(320+w*36), spd:55, tag:'ground', cls:'boss'})
  };

  // ---------- UI helpers ----------
  function show(id){$(id).classList.add('show');}
  function hide(id){$(id).classList.remove('show');}

  // ---------- Build Stage ----------
  function buildStage(idx){
    const st=STAGES[(idx-1)%STAGES.length];
    world.style.backgroundImage=`url('${st.bg}')`;
    world.innerHTML='';
    S.tiles=[]; S.path=[];
    S.rangeIndicator=el('div','range-indicator'); S.rangeIndicator.style.display='none'; world.appendChild(S.rangeIndicator);

    for(let r=0;r<GRID.rows;r++){
      for(let c=0;c<GRID.cols;c++){
        const t=el('div','tile build');
        t.style.left=(c*GRID.size)+'px';
        t.style.top=(r*GRID.size)+'px';
        world.appendChild(t);
        S.tiles.push({el:t,r,c,type:'build'});
      }
    }
    for(const [r,c] of st.path){
      const idx=r*GRID.cols+c; const tile=S.tiles[idx];
      tile.type='path'; tile.el.classList.remove('build'); tile.el.classList.add('path');
      S.path.push({x:c*GRID.size+GRID.size/2, y:r*GRID.size+GRID.size/2});
    }
    const goal=S.path[S.path.length-1]; const base=el('div','base'); base.style.left=(goal.x-21)+'px'; base.style.top=(goal.y-21)+'px'; world.appendChild(base);
    S.start=S.path[0]; S.goal=goal;
  }

  // ---------- Game Core ----------
  function updHUD(){ ui.stage.textContent=S.stage; ui.wave.textContent=S.wave; ui.hp.textContent=S.baseHP; ui.gold.textContent=S.gold; renderBag(); }
  function selectTower(t){
    if(S.selected && S.selected.el) S.selected.el.classList.remove('highlight');
    S.selected=t;
    if(t && t.el){
      t.el.classList.add('highlight');
      S.rangeIndicator.style.display='block';
      S.rangeIndicator.style.width=t.rng*2+'px';
      S.rangeIndicator.style.height=t.rng*2+'px';
      S.rangeIndicator.style.left=(t.x - t.rng)+'px';
      S.rangeIndicator.style.top=(t.y - t.rng)+'px';
    } else {
      S.rangeIndicator.style.display='none';
    }
  }

  function placeTower(kind,r,c){
    const def=DEF_TOWER[kind];
    if(S.gold<def.cost){ tip('‡∏ó‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
    const tile=S.tiles[r*GRID.cols+c];
    if(tile.type!=='build'){ tip('‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ö‡∏ô‡∏ä‡πà‡∏≠‡∏á Build'); return; }
    for(const t of S.towers){ if(t.r===r && t.c===c){ tip('‡∏°‡∏µ‡∏õ‡πâ‡∏≠‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'); return; } }
    S.gold-=def.cost; updHUD();
    const d=el('div','tower sprite'); d.style.backgroundImage=`url('${assets.tower[kind]}')`;
    d.style.left=(tile.el.offsetLeft+3)+'px'; d.style.top=(tile.el.offsetTop+3)+'px'; world.appendChild(d);
    const tow={el:d,kind,r,c,x:tile.el.offsetLeft+GRID.size/2,y:tile.el.offsetTop+GRID.size/2,dmg:def.dmg,rng:def.rng,rof:def.rof,aa:def.aa,slow:def.slow,splash:def.splash,cd:0,lv:1,invested:def.cost};
    d.addEventListener('click',e=>{e.stopPropagation(); selectTower(tow);});
    d.addEventListener('touchstart',e=>{e.preventDefault(); e.stopPropagation(); selectTower(tow);},{passive:false});
    S.towers.push(tow); selectTower(tow);
  }

  function sellSelected(){
    const t=S.selected; if(!t){ tip('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡πâ‡∏≠‡∏°'); return; }
    const refund=Math.floor(t.invested*0.6); S.gold+=refund; t.el.remove();
    S.towers=S.towers.filter(x=>x!==t); selectTower(null); updHUD();
    tip('‡∏Ç‡∏≤‡∏¢‡∏õ‡πâ‡∏≠‡∏° +'+refund+'G');
  }

  function dmgMultiplier(){
    let m=1;
    if(S.research.ball1) m*=1.10;
    if(S.research.ball2) m*=1.10;
    return m;
  }

  function shoot(t,e){
    const b=el('div','bullet '+t.kind); world.appendChild(b);
    S.bullets.push({el:b,x:t.x,y:t.y,target:e,dmg:t.dmg*dmgMultiplier(),speed:300,slow:t.slow,slowDur:1600,splash:t.splash});
  }
  function towerStep(t,dt){
    t.cd-=dt; if(t.cd>0) return;
    let best=null, bestD=1e9;
    for(const e of S.enemies){
      if(!e.alive) continue;
      if(e.tag==='air' && !t.aa) continue;
      const d=dist(t.x,t.y,e.x+14,e.y+14);
      if(d<t.rng && d<bestD){ best=e; bestD=d; }
    }
    if(best){ shoot(t,best); const rofBoost=(S._ocTimer>0?1.7:1.0); t.cd=1000/Math.max(0.1,t.rof*rofBoost); }
  }
  function enemyStep(e,dt){
    if(e.slowT>0){ e.slowT-=dt; if(e.slowT<=0) e.slow=1; }
    const target=S.path[e.idx+1];
    if(!target){ e.alive=false; e.el.remove(); S.baseHP=clamp(S.baseHP-1,0,99); updHUD(); if(S.baseHP<=0) gameOver(); return; }
    const cx=e.x+14, cy=e.y+14;
    const ang=Math.atan2(target.y-cy,target.x-cx);
    const st=STAGES[(S.stage-1)%STAGES.length];
    const speedFactor=st.mod.speed;
    const sp=e.spd*e.slow*(dt/1000)*speedFactor;
    e.x+=Math.cos(ang)*sp; e.y+=Math.sin(ang)*sp;
    e.el.style.left=e.x+'px'; e.el.style.top=e.y+'px';
    if(dist(cx,cy,target.x,target.y)<6) e.idx++;
  }
  function projectileStep(p,dt){
    if(!p.target || !p.target.alive){ p.dead=true; p.el.remove(); return; }
    const dx=(p.target.x+14)-p.x, dy=(p.target.y+14)-p.y;
    const d=Math.hypot(dx,dy); const sp=p.speed*(dt/1000);
    p.x+=dx/d*sp; p.y+=dy/d*sp; p.el.style.left=p.x+'px'; p.el.style.top=p.y+'px';
    if(d<8){
      if(p.splash>0){
        const expl=el('div','explosion');
        expl.style.left=(p.x-p.splash/2-5)+'px'; expl.style.top=(p.y-p.splash/2-5)+'px';
        expl.style.width=p.splash*2+'px'; expl.style.height=p.splash*2+'px';
        world.appendChild(expl); setTimeout(()=>expl.remove(),300);
        for(const e of S.enemies){ if(!e.alive||e.tag==='air') continue;
          if(dist(p.x,p.y,e.x+14,e.y+14)<p.splash) dealDamage(e,p.dmg);
        }
      } else {
        dealDamage(p.target,p.dmg);
        if(p.slow>0 && p.target.tag!=='air'){ p.target.slow=Math.max(0.35,1-p.slow); p.target.slowT=p.slowDur; }
      }
      p.dead=true; p.el.remove();
    }
  }
  function dealDamage(e, dmg){
    e.hp-=dmg;
    if(e.hp<=0) killEnemy(e);
    else e.healthBar.style.width=(e.hp/e.maxHP*100)+'%';
  }
  function killEnemy(e){
    if(!e.alive) return; e.alive=false; e.el.remove();
    const base=6+Math.floor(S.wave/2);
    const bonus=(e.kind==='boss'?60:(e.kind==='brute'?8:0));
    const diffR=DIFF[S.difficulty].reward;
    S.gold += Math.floor((base+bonus)*diffR);
    // ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢: ‡∏î‡∏£‡∏≠‡∏õ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
    const r=Math.random();
    if(e.kind==='boss'){ addInv('‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•‡∏´‡∏≤‡∏¢‡∏≤‡∏Å'); }
    else if(r<0.5){ addInv('‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô'); }
    else if(r<0.8){ addInv('‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç'); }
    updHUD();
  }

  // ---------- Waves ----------
  function spawnEnemy(kind){
    const w=S.wave;
    const def=DEF_ENEMY[kind](w);
    const st=STAGES[(S.stage-1)%STAGES.length];
    // scale difficulty
    const scale=DIFF[S.difficulty].enemyHP * S.difficultyScale;
    const HP=Math.floor(def.hp*scale);
    const eEl=el('div','enemy sprite'); eEl.style.backgroundImage=`url('${assets.enemy[kind]}')`;
    const hb=el('div','health-bar'); const hbi=el('div','health-bar-inner'); hb.appendChild(hbi); eEl.appendChild(hb);
    world.appendChild(eEl);
    const e={el:eEl,healthBar:hbi,kind,tag:def.tag,hp:HP,maxHP:HP,spd:def.spd,idx:0,x:S.start.x-14,y:S.start.y-14,alive:true,slow:1,slowT:0};
    eEl.style.left=e.x+'px'; eEl.style.top=e.y+'px';
    S.enemies.push(e);
  }
  function startWave(){
    if(S.running){ tip('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ'); return; }
    S.running=true; tip('Wave '+S.wave);
    const n=S.wave; const st=STAGES[(S.stage-1)%STAGES.length];
    let pack=[];
    if(n%5===0){ pack=Array(8).fill('runner').concat(Array(4).fill('brute')).concat(['boss']); }
    else {
      pack=Array(6+Math.floor(n*0.7)).fill('runner');
      if(n>2) pack=pack.concat(Array(Math.max(1,Math.floor(n/3))).fill('brute'));
      if(n>3) pack=pack.concat(Array(Math.max(1,Math.floor(n/4*st.mod.flyer))).fill('flyer'));
      if(n>4) pack=pack.concat(Array(Math.max(2,Math.floor(n/2))).fill('bandit'));
    }
    let i=0;
    const iv=setInterval(()=>{
      if(!S.paused && S.running){
        spawnEnemy(pack[i]); i++; if(i>=pack.length){ clearInterval(iv); }
      }
    }, Math.max(200,520 - S.wave*18));
  }
  function checkWaveEnd(){
    if(S.running && S.enemies.length===0){
      S.running=false; S.wave++;
      // Interest
      const baseInterest = 5; // 5G/100G
      let extra = 0;
      if(S.research.fin1) extra += 2;
      if(S.research.fin2) extra += 3;
      const interestPer100 = baseInterest + extra;
      const interest = Math.floor(S.gold/100)*interestPer100;
      const diffR=DIFF[S.difficulty].reward;
      S.gold += Math.floor(24*diffR) + interest;
      tip(`‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏ß‡∏ü +${Math.floor(24*diffR)}G (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ +${interest}G)`);
      updHUD();

      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Stage ‡∏ó‡∏∏‡∏Å 10 Wave
      if(S.wave>10){
        S.wave=1; S.stage++;
        if(S.endless){ S.difficultyScale*=1.07; } // ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡πÇ‡∏´‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
        S.towers.forEach(t=>{ /* ‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà */ });
        S.enemies=[]; S.bullets=[];
        buildStage(S.stage);
        tip('Stage ‡πÉ‡∏´‡∏°‡πà!');
      }
    }
  }

  // ---------- Items / Shop ----------
  function renderBag(){
    ui.bag.innerHTML='';
    if(S.items.bomb) ui.bag.appendChild(tag(`üí£ Bomb x${S.items.bomb}`));
    if(S.items.freeze) ui.bag.appendChild(tag(`‚ùÑÔ∏è Freeze x${S.items.freeze}`));
    if(S.items.oc) ui.bag.appendChild(tag(`‚öôÔ∏è Overclock x${S.items.oc}`));
  }
  function tag(s){ const d=el('div','tag'); d.textContent=s; return d; }
  function buy(cost, cb){
    if(S.running){ tip('‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á wave ‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ö‡∏≤‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤'); }
    if(S.gold<cost){ tip('‡∏ó‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
    S.gold-=cost; cb(); updHUD();
  }
  function openShop(){ show('shop'); }
  function closeShop(){ hide('shop'); }
  function openLab(){ show('lab'); }
  function closeLab(){ hide('lab'); }

  // Use Items
  function useBomb(x,y){
    const radius=70, dmg=120;
    const ex=el('div','meteor-impact'); ex.style.left=(x-50)+'px'; ex.style.top=(y-50)+'px'; world.appendChild(ex); setTimeout(()=>ex.remove(),350);
    for(const e of S.enemies){ if(!e.alive||e.tag==='air') continue; if(dist(x,y,e.x+14,e.y+14)<radius) dealDamage(e,dmg); }
  }
  function useFreeze(x,y){
    const radius=90, slow=0.4, dur=1800;
    const ex=el('div','meteor-impact'); ex.style.background='rgba(59,130,246,.7)'; ex.style.left=(x-50)+'px'; ex.style.top=(y-50)+'px'; world.appendChild(ex); setTimeout(()=>ex.remove(),350);
    for(const e of S.enemies){ if(!e.alive||e.tag==='air') continue; if(dist(x,y,e.x+14,e.y+14)<radius){ e.slow=Math.min(e.slow,slow); e.slowT=dur; } }
  }
  function useOverclock(){
    if(S._ocTimer>0){ tip('Overclock ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà'); return; }
    S._ocTimer=6000; tip('‚öôÔ∏è Overclock!');
  }

  // ---------- Research ----------
  function doResearch(key,cost,apply){
    if(S.gold<cost){ tip('‡∏ó‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
    if(S.research[key]){ tip('‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); return; }
    S.gold-=cost; S.research[key]=true; apply && apply(); updHUD(); tip('‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }

  // ---------- Meteor ----------
  function castMeteor(x,y){
    let bonus=0;
    if(S.research.arc1) bonus+=20;
    if(S.research.arc2) bonus+=30;
    const price=120;
    if(S.gold<price){ tip('‡∏ó‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
    S.gold-=price; updHUD();
    const impact=el('div','meteor-impact'); impact.style.left=(x-50)+'px'; impact.style.top=(y-50)+'px'; world.appendChild(impact); setTimeout(()=>impact.remove(),400);
    for(const e of S.enemies){ if(!e.alive||e.tag==='air') continue; if(dist(x,y,e.x+14,e.y+14)<50) dealDamage(e,85+bonus); }
    tip('‚òÑÔ∏è Meteor!');
  }

  // ---------- Loop ----------
  let waveTimer=0;
  function loop(ts){
    if(!S.last) S.last=ts; const dt=ts-S.last; S.last=ts;
    if(!S.paused){
      // overclock timer
      if(S._ocTimer>0){ S._ocTimer-=dt; if(S._ocTimer<0) S._ocTimer=0; }
      for(const e of S.enemies){ if(e.alive) enemyStep(e,dt); }
      for(const t of S.towers){ towerStep(t,dt); }
      for(const b of S.bullets){ projectileStep(b,dt); }
      S.enemies=S.enemies.filter(e=>e.alive);
      S.bullets=S.bullets.filter(b=>!b.dead);
      waveTimer+=dt; if(waveTimer>800){ checkWaveEnd(); waveTimer=0; }
    }
    RAF(loop);
  }

  // ---------- Controls ----------
  $("btnStart").onclick=startWave;
  $("btnPause").onclick=()=>{ S.paused=!S.paused; $("btnPause").textContent=S.paused?'‚ñ∂ Resume':'‚è∏ Pause'; };
  $("btnPlace").onclick=()=>{ S.mode=(S.mode==='place'?null:'place'); world.style.cursor= S.mode?'copy':'crosshair'; tip('‡πÅ‡∏ï‡∏∞‡∏ä‡πà‡∏≠‡∏á Build ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏°'); };
  $("btnSell").onclick=sellSelected;
  $("btnMeteor").onclick=()=>{ S.mode='meteor'; world.style.cursor='cell'; tip('‡πÅ‡∏ï‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Meteor'); };
  $("btnShop").onclick=openShop; $("shopClose").onclick=closeShop;
  $("btnResearch").onclick=openLab; $("labClose").onclick=closeLab;

  // Shop buttons
  $("buyBomb").onclick=()=>buy(60,()=>{ S.items.bomb++; });
  $("buyFreeze").onclick=()=>buy(70,()=>{ S.items.freeze++; });
  $("buyOC").onclick=()=>buy(90,()=>{ S.items.oc++; });
  $("reroll").onclick=()=>buy(15,()=>{ tip('‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä (‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå)'); });

  // Research buttons
  document.querySelectorAll('#lab [data-r]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const key=btn.dataset.r;
      const map={
        ball1:()=>doResearch('ball1',120,null),
        ball2:()=>doResearch('ball2',220,null),
        fin1: ()=>doResearch('fin1',100,null),
        fin2: ()=>doResearch('fin2',200,null),
        arc1: ()=>doResearch('arc1',120,null),
        arc2: ()=>doResearch('arc2',240,null),
      };
      map[key]&&map[key]();
    });
  });

  // clicks on world
  function handleWorldClick(x,y){
    // Use items if chosen
    if(S.mode==='meteor'){ castMeteor(x,y); S.mode=null; world.style.cursor='crosshair'; return; }

    // Use items from bag by long-tap/secondary? ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Bomb/Freeze ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞‡∏Ç‡∏ì‡∏∞‡∏Å‡∏î Shop ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
    if(S.items.bomb && !S.running){ /* ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° wave ‡∏Å‡πá‡πÑ‡∏î‡πâ */ }
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á wave: ‡πÅ‡∏ï‡∏∞‡∏™‡∏≠‡∏á‡∏ô‡∏¥‡πâ‡∏ß? ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô Shop: ‡∏õ‡∏¥‡∏î Shop ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞‡∏™‡∏ô‡∏≤‡∏°:
    if(S._use==='bomb'){ useBomb(x,y); S.items.bomb--; S._use=null; renderBag(); return; }
    if(S._use==='freeze'){ useFreeze(x,y); S.items.freeze--; S._use=null; renderBag(); return; }

    // place or deselect
    const r=Math.floor(y/GRID.size), c=Math.floor(x/GRID.size);
    if(r<0||c<0||r>=GRID.rows||c>=GRID.cols) return;
    const tile=S.tiles[r*GRID.cols+c];
    if(S.mode==='place'){ const kind=$('selTower').value; placeTower(kind,r,c); S.mode=null; world.style.cursor='crosshair'; return; }
    if(tile.type==='build') selectTower(null);
  }
  world.addEventListener('click',e=>{ if(e.target.closest('.tower')) return; const rect=world.getBoundingClientRect(); handleWorldClick(e.clientX-rect.left, e.clientY-rect.top); });
  world.addEventListener('touchstart',e=>{ if(e.target.closest('.tower')) return; const t=e.touches[0]; const rect=world.getBoundingClientRect(); handleWorldClick(t.clientX-rect.left,t.clientY-rect.top); },{passive:true});

  // Bag item quick use toggles (‡∏Å‡∏î‡∏ó‡∏µ‡πà tag ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏ä‡πâ)
  ui.bag.addEventListener('click',e=>{
    const txt=e.target.textContent||'';
    if(/Bomb/.test(txt)){ S._use = (S._use==='bomb'?null:'bomb'); tip(S._use?'‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Bomb':'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ Bomb'); }
    else if(/Freeze/.test(txt)){ S._use = (S._use==='freeze'?null:'freeze'); tip(S._use?'‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Freeze':'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ Freeze'); }
    else if(/Overclock/.test(txt)){ if(S.items.oc>0){ useOverclock(); S.items.oc--; renderBag(); } }
  });

  // ---------- Init ----------
  function addInv(name){ const d=el('div','tag'); d.textContent=name; /* ‡πÅ‡∏Ñ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏î‡∏£‡∏≠‡∏õ */ }
  function gameOver(){ S.paused=true; S.running=false; tip('‡∏ê‡∏≤‡∏ô‡πÅ‡∏ï‡∏Å! ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà'); }

  function initGame(){
    const diff=DIFF[S.difficulty];
    S.baseHP=diff.hp; S.gold=diff.gold; S.wave=1; S.stage=1; S.difficultyScale=1.0;
    S.towers=[]; S.enemies=[]; S.bullets=[]; S.items={bomb:0,freeze:0,oc:0};
    S.research={ball1:false,ball2:false,fin1:false,fin2:false,arc1:false,arc2:false};
    buildStage(S.stage); updHUD(); selectTower(null); tip('‡∏ß‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏° Wave');
  }

  // Overlay start
  $("ovrGo").onclick=()=>{
    S.difficulty = $("selDiff").value;
    S.endless = $("chkEndless").checked;
    hide('overlay');
    initGame();
  };

  // Run loop
  RAF(loop);
})();
</script>
</body>
</html>
