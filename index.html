<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>TONY TD ‚Äî Canvas v1.0</title>
<style>
  :root{--bg:#0b1220;--ink:#e2e8f0;--mut:#94a3b8;--card:#0f172a;--line:#334155;--pri:#22d3ee;--acc:#60a5fa;--ok:#22c55e;--bad:#ef4444;--gold:#facc15}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0;padding:0;overscroll-behavior:none;background:var(--bg);color:var(--ink);font:14px system-ui,Inter,Segoe UI,Roboto;-webkit-font-smoothing:antialiased}
  .wrap{max-width:1200px;margin:8px auto;padding:10px}
  .header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .title{font-size:18px;font-weight:800}
  .btn{background:var(--pri);color:#001b2a;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
  .btn.small{padding:8px 12px}
  .badge{border:1px solid var(--line);padding:6px 10px;border-radius:10px;color:var(--mut);display:flex;gap:6px;align-items:center}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:10px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
  .section{margin:0 0 8px 0;font-weight:800}
  #stageWrap{position:relative}
  #stage{display:block;border:1px solid var(--line);border-radius:12px;background:#0a0f1a;touch-action:none}
  .panel{border:1px solid var(--line);border-radius:10px;padding:8px;background:#0b1220}
  .kv{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed var(--line);color:var(--mut)}
  .list{max-height:180px;overflow:auto;border:1px dashed var(--line);border-radius:8px;padding:6px;background:#0b1220}
  .inv{display:flex;gap:6px;flex-wrap:wrap}
  .tag{border:1px solid var(--line);padding:6px 8px;border-radius:999px;background:#0b1220;color:var(--mut)}
  .note{color:#93c5fd}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:var(--pri);color:#001b2a;padding:8px 12px;border-radius:10px;font-weight:800;z-index:9999}
  #overlay{position:fixed;inset:0;background:rgba(2,6,23,.9);display:flex;align-items:center;justify-content:center;z-index:9998}
  #overlay .box{max-width:760px;background:#0f172a;border:1px solid #334155;border-radius:16px;padding:14px;text-align:center}
  select,input{background:#0b1220;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px}
</style>
</head>
<body>
<div id="overlay">
  <div class="box">
    <h2>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Canvas)</h2>
    <p class="note">‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏ä‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÉ‡∏ô iPhone ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏ü‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    <div class="row" style="display:flex;gap:8px;justify-content:center">
      <button id="ovrGo" class="btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="header">
    <div class="row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div class="title">TONY TD ‚Äî Canvas v1.0</div>
      <button id="btnStart" class="btn small">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏° Wave</button>
      <button id="btnPause" class="btn small ghost">‚è∏ Pause</button>
      <button id="btnSpeed" class="btn small ghost">‚è© 1x</button>
      <button id="btnReset" class="btn small ghost">üóëÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      <div class="badge">HP: <b id="hp">20</b></div>
      <div class="badge">‡∏ó‡∏≠‡∏á: <b id="gold">180</b></div>
      <div class="badge">Wave: <b id="wave">1</b></div>
    </div>
    <div class="row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <select id="selTower">
        <option value="gun">‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏∑‡∏ô (50G)</option>
        <option value="sniper">‡∏™‡πÑ‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå (80G)</option>
        <option value="frost">‡∏ü‡∏£‡∏≠‡∏™‡∏ï‡πå‡∏™‡πÇ‡∏•‡∏ß‡πå (60G)</option>
      </select>
      <button id="btnPlace" class="btn small">‡∏ß‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏°</button>
      <button id="btnSell" class="btn small ghost">‡∏Ç‡∏≤‡∏¢‡∏õ‡πâ‡∏≠‡∏° (+60%)</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3 class="section">‡∏™‡∏ô‡∏≤‡∏°‡∏£‡∏ö (Canvas)</h3>
      <div id="stageWrap">
        <canvas id="stage" width="760" height="460"></canvas>
      </div>
      <div class="note" style="margin-top:6px">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞ "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á" ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ~1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡∏∞</div>
    </div>

    <div class="card">
      <div class="panel" style="margin-bottom:8px">
        <h3 class="section" style="margin:0 0 6px 0">‡∏õ‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h3>
        <div id="selInfo" class="list" style="max-height:120px"></div>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnUpDmg" class="btn small ghost">‡∏≠‡∏±‡∏õ DMG (‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô 5)</button>
          <button id="btnUpRng" class="btn small ghost">‡∏≠‡∏±‡∏õ ‡∏£‡∏∞‡∏¢‡∏∞ (‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô 5)</button>
          <button id="btnUpRof" class="btn small ghost">‡∏≠‡∏±‡∏õ ‡∏¢‡∏¥‡∏á‡πÄ‡∏£‡πá‡∏ß (‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 5)</button>
        </div>
      </div>

      <div class="panel" style="margin-bottom:8px">
        <h3 class="section" style="margin:0 0 6px 0">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</h3>
        <div id="inv" class="inv"></div>
        <div class="kv"><span>‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô</span><b id="mats">0</b></div>
        <div class="kv"><span>‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÇ‡∏ö‡∏£‡∏≤‡∏ì</span><b id="coins">0</b></div>
        <div class="kv"><span>‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•‡∏´‡∏≤‡∏¢‡∏≤‡∏Å</span><b id="rare">0</b></div>
      </div>

      <div class="panel" style="margin-bottom:8px">
        <h3 class="section" style="margin:0 0 6px 0">‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</h3>
        <div id="market" class="list"></div>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <select id="sellItem">
            <option value="mat">‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô x5</option>
            <option value="rare">‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏• x1</option>
          </select>
          <input id="sellPrice" type="number" min="1" value="90" style="width:90px">
          <button id="btnList" class="btn small">‡∏•‡∏á‡∏Ç‡∏≤‡∏¢</button>
        </div>
        <div class="note">*‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡πÄ‡∏Å‡∏°‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° 10% ‚Ä¢ ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
      </div>

      <div class="panel">
        <h3 class="section" style="margin:0 0 6px 0">‡∏£‡πâ‡∏≤‡∏ô NPC (‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</h3>
        <div class="kv"><span>‡∏Ç‡∏≤‡∏¢ ‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô x5</span><span><b id="priceMat5">70</b>G <button id="npcSellMat" class="btn small" style="margin-left:6px">‡∏Ç‡∏≤‡∏¢</button></span></div>
        <div class="kv"><span>‡∏Ç‡∏≤‡∏¢ ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÇ‡∏ö‡∏£‡∏≤‡∏ì x1</span><span><b id="priceCoin1">20</b>G <button id="npcSellCoin" class="btn small" style="margin-left:6px">‡∏Ç‡∏≤‡∏¢</button></span></div>
        <div class="kv"><span>‡∏Ç‡∏≤‡∏¢ ‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•‡∏´‡∏≤‡∏¢‡∏≤‡∏Å x1</span><span><b id="priceRare1">200</b>G <button id="npcSellRare" class="btn small" style="margin-left:6px">‡∏Ç‡∏≤‡∏¢</button></span></div>
        <div class="note">‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡πâ NPC ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏™‡∏π‡∏á) ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏à‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const canvas=$("stage"), ctx=canvas.getContext('2d');
  const RAF=window.requestAnimationFrame||(fn=>setTimeout(()=>fn(performance.now()),16));
  function el(tag,cls){const d=document.createElement(tag); if(cls) d.className=cls; return d;}
  function tip(s){const d=el('div','toast'); d.textContent=s; document.body.appendChild(d); setTimeout(()=>d.remove(),1200);}
  function clamp(n,a,b){return Math.max(a,Math.min(b,n));}
  function dist(ax,ay,bx,by){return Math.hypot(ax-bx, ay-by);}

  const PRICES={sell:{mat5:70,coin1:20,rare1:200}};
  const ui={hp:$("hp"),gold:$("gold"),wave:$("wave"),selInfo:$("selInfo"),inv:$("inv"),mats:$("mats"),coins:$("coins"),rare:$("rare"),market:$("market")};

  // ---- WORLD/GRID ----
  const GRID={rows:9, cols:16, size:46, off:6};
  const W=GRID.cols*GRID.size+GRID.off*2, H=GRID.rows*GRID.size+GRID.off*2;
  canvas.width=W; canvas.height=H;

  const S={
    baseHP:20,gold:180,wave:1,speed:1,
    running:false,paused:false,last:0,
    path:[], start:null, goal:null,
    towers:[], enemies:[], bullets:[],
    mats:0, coins:0, rare:0, listings:[],
    selected:null, mode:null,
    spawnQ:[], spawnTimer:0, spawnGap:400
  };

  // ---- MAP & PATH ----
  const PATH_RC=[[4,0],[4,1],[4,2],[4,3],[3,3],[2,3],[2,4],[2,5],[3,5],[4,5],[5,5],[6,5],[6,6],[6,7],[5,7],[4,7],[3,7],[3,8],[3,9],[4,9],[5,9],[6,9],[7,9],[7,10],[7,11],[6,11],[5,11],[4,11],[3,11],[2,11],[2,12],[2,13],[3,13],[4,13],[5,13],[5,14],[5,15]];
  function rc2xy(r,c){return {x:c*GRID.size+GRID.off+GRID.size/2, y:r*GRID.size+GRID.off+GRID.size/2};}
  function buildMap(){
    S.path = PATH_RC.map(([r,c])=>rc2xy(r,c));
    S.start = S.path[0]; S.goal = S.path[S.path.length-1];
  }

  // ---- DEFINITIONS ----
  const DEF_TOWER={
    gun:{name:'‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏∑‡∏ô',cost:50,dmg:6,rng:120,rof:1.6,aa:true,slow:0,color:'#22c55e'},
    sniper:{name:'‡∏™‡πÑ‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå',cost:80,dmg:22,rng:240,rof:0.55,aa:true,slow:0,color:'#38bdf8'},
    frost:{name:'‡∏ü‡∏£‡∏≠‡∏™‡∏ï‡πå',cost:60,dmg:5,rng:130,rof:1.0,aa:false,slow:0.45,color:'#a5f3fc'}
  };
  const DEF_ENEMY={
    runner:w=>({hp:12+w*1, spd:85, tag:'ground', color:'#ef4444'}),
    brute:w=>({hp:42+w*5, spd:45, tag:'ground', color:'#8b5cf6'}),
    flyer:w=>({hp:16+w*2, spd:78, tag:'air', color:'#f97316'}),
    boss:w=>({hp:320+w*36, spd:55, tag:'ground', color:'#f59e0b'})
  };

  // ---- TOWERS ----
  function placeTower(kind, r, c){
    const def=DEF_TOWER[kind];
    if(S.gold<def.cost){ tip('‡∏ó‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
    // ‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á build (‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô path)
    if(PATH_RC.some(([rr,cc])=>rr===r&&cc===c)){ tip('‡∏ß‡∏≤‡∏á‡∏ö‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); return; }
    // ‡∏ß‡∏≤‡∏á‡∏ã‡πâ‡∏≥‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°?
    if(S.towers.some(t=>t.r===r&&t.c===c)){ tip('‡∏°‡∏µ‡∏õ‡πâ‡∏≠‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'); return; }
    S.gold -= def.cost; upd();
    const tile=rc2xy(r,c);
    const tow={
      kind,r,c,x:tile.x,y:tile.y,
      dmg:def.dmg,rng:def.rng,rof:def.rof,aa:def.aa,slow:def.slow,
      cd:0, lv:1, invested:def.cost, color:def.color
    };
    S.towers.push(tow);
    selectTower(tow);
  }
  function selectTower(t){ S.selected=t||null; renderSelected(); }
  function sellSelected(){
    const t=S.selected; if(!t){ tip('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡πâ‡∏≠‡∏°'); return; }
    const refund=Math.floor(t.invested*0.6);
    S.gold+=refund;
    S.towers=S.towers.filter(x=>x!==t);
    selectTower(null); upd(); tip('‡∏Ç‡∏≤‡∏¢‡∏õ‡πâ‡∏≠‡∏° +'+refund+'G');
  }
  function renderSelected(){
    const box=ui.selInfo; box.innerHTML='';
    const t=S.selected; if(!t){ box.innerHTML='<div class="note">‡πÅ‡∏ï‡∏∞‡∏ä‡πà‡∏≠‡∏á Build ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á/‡πÅ‡∏ï‡∏∞‡∏õ‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>'; return; }
    const def=DEF_TOWER[t.kind];
    box.innerHTML = `
      <div class="kv"><span>‡∏ä‡∏ô‡∏¥‡∏î</span><b>${def.name}</b></div>
      <div class="kv"><span>LV</span><b>${t.lv}</b></div>
      <div class="kv"><span>DMG</span><b>${t.dmg.toFixed(1)}</b></div>
      <div class="kv"><span>Range</span><b>${Math.round(t.rng)}</b></div>
      <div class="kv"><span>ROF</span><b>${t.rof.toFixed(2)}/s</b></div>
      <div class="note">‡∏ü‡∏£‡∏≠‡∏™‡∏ï‡πå‡∏ä‡∏∞‡∏•‡∏≠‡∏®‡∏±‡∏ï‡∏£‡∏π, ‡∏™‡πÑ‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏¢‡∏¥‡∏á‡πÑ‡∏Å‡∏•‡πÅ‡∏£‡∏á, ‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏∑‡∏ô‡∏™‡∏°‡∏î‡∏∏‡∏•</div>`;
  }
  function upgradeSelected(stat){
    const t=S.selected; if(!t){ tip('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡πâ‡∏≠‡∏°'); return; }
    if(stat==='dmg'){
      if(S.mats<5){ tip('‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
      S.mats-=5; t.dmg*=1.25; t.lv++; tip('‡∏≠‡∏±‡∏õ DMG +25%');
    }else if(stat==='rng'){
      if(S.mats<5){ tip('‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
      S.mats-=5; t.rng*=1.15; t.lv++; tip('‡∏≠‡∏±‡∏õ ‡∏£‡∏∞‡∏¢‡∏∞ +15%');
    }else if(stat==='rof'){
      if(S.coins<5){ tip('‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
      S.coins-=5; t.rof*=1.15; t.lv++; tip('‡∏≠‡∏±‡∏õ ‡∏¢‡∏¥‡∏á‡πÄ‡∏£‡πá‡∏ß +15%');
    }
    renderSelected(); upd();
  }

  // ---- ENEMIES / BULLETS ----
  function spawnEnemy(kind){
    const def=DEF_ENEMY[kind](S.wave);
    const e={
      kind, hp:def.hp, max:def.hp, spd:def.spd, tag:def.tag,
      idx:0, x:S.start.x-10, y:S.start.y-10, alive:true,
      slow:1, slowT:0, worth:6+Math.floor(S.wave/2), color:def.color
    };
    S.enemies.push(e);
  }
  function shoot(t,e){
    const b={x:t.x, y:t.y, target:e, dmg:t.dmg, speed:300, slow:t.slow, slowDur:1600, dead:false, color:(t.kind==='frost'?'#a5f3fc':'#60a5fa')};
    S.bullets.push(b);
  }
  function towerStep(t,dt){
    t.cd -= dt*S.speed; if(t.cd>0) return;
    let best=null, bestD=1e9;
    for(const e of S.enemies){
      if(!e.alive) continue;
      if(e.tag==='air' && !t.aa) continue;
      const d=dist(t.x,t.y, e.x+10, e.y+10);
      if(d<t.rng && d<bestD){ bestD=d; best=e; }
    }
    if(best){ shoot(t,best); t.cd = 1000/Math.max(0.1,t.rof); }
  }
  function enemyStep(e,dt){
    if(e.slowT>0){ e.slowT -= dt*S.speed; if(e.slowT<=0) e.slow=1; }
    const target=S.path[e.idx+1];
    if(!target){
      e.alive=false;
      S.baseHP=clamp(S.baseHP-1,0,99); upd();
      if(S.baseHP<=0) gameOver();
      return;
    }
    const cx=e.x+10, cy=e.y+10;
    const ang=Math.atan2(target.y-cy, target.x-cx);
    const sp=e.spd*e.slow*(dt/1000)*S.speed;
    e.x+=Math.cos(ang)*sp; e.y+=Math.sin(ang)*sp;
    if(dist(cx,cy,target.x,target.y)<6) e.idx++;
  }
  function bulletStep(p,dt){
    if(!p.target||!p.target.alive){ p.dead=true; return; }
    const dx=(p.target.x+10)-p.x, dy=(p.target.y+10)-p.y;
    const d=Math.hypot(dx,dy);
    const sp=p.speed*(dt/1000)*S.speed;
    p.x+=dx/d*sp; p.y+=dy/d*sp;
    if(d<8){
      p.target.hp-=p.dmg;
      if(p.slow>0 && p.target.tag!=='air'){
        p.target.slow = Math.max(0.35, p.target.slow * p.slow);
        p.target.slowT = p.slowDur; // ‡∏´‡∏ô‡πà‡∏ß‡∏¢ ms ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö dt
      }
      if(p.target.hp<=0) killEnemy(p.target);
      p.dead=true;
    }
  }
  function addInv(name){
    const d=el('div','tag'); d.textContent=name; ui.inv.appendChild(d);
    if(ui.inv.childNodes.length>40) ui.inv.removeChild(ui.inv.firstChild);
  }
  function killEnemy(e){
    e.alive=false;
    const bonus=(e.kind==='boss'?60:(e.kind==='brute'?8:0));
    S.gold += 6 + Math.floor(S.wave/2) + bonus;
    const roll=Math.random();
    if(e.kind==='boss'){ S.rare+=1; addInv('‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•‡∏´‡∏≤‡∏¢‡∏≤‡∏Å'); }
    else if(roll<0.55){ S.mats+=1; addInv('‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô'); }
    else if(roll<0.85){ S.coins+=1; addInv('‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÇ‡∏ö‡∏£‡∏≤‡∏ì'); }
    else if(Math.random()<0.2){ S.rare+=1; addInv('‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•‡∏´‡∏≤‡∏¢‡∏≤‡∏Å'); }
    upd();
  }

  // ---- MARKET / NPC ----
  function renderMarket(){
    const box=ui.market; box.innerHTML='';
    if(!S.listings.length){ box.innerHTML='<div class="note">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢ ‡∏•‡∏≠‡∏á‡∏•‡∏á‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</div>'; return; }
    S.listings.forEach((it,idx)=>{
      const row=el('div'); row.className='kv';
      row.innerHTML=`<span>${it.name} x${it.qty}</span><b>${it.price}G</b>`;
      const buy=el('button','btn small'); buy.textContent='‡∏ã‡∏∑‡πâ‡∏≠'; buy.style.marginLeft='8px';
      buy.addEventListener('click',()=>{
        if(S.gold<it.price){ tip('‡∏ó‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
        S.gold-=it.price;
        if(it.name==='‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô') S.mats+=it.qty;
        if(it.name==='‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•‡∏´‡∏≤‡∏¢‡∏≤‡∏Å') S.rare+=it.qty;
        if(it.name==='‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÇ‡∏ö‡∏£‡∏≤‡∏ì') S.coins+=it.qty;
        S.listings.splice(idx,1); upd(); tip('‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      });
      row.appendChild(buy); box.appendChild(row);
    });
  }
  function npcSell(kind){
    if(kind==='mat5'){
      if(S.mats<5){ tip('‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ (‚â•5)'); return; }
      S.mats-=5; S.gold+=PRICES.sell.mat5; tip('‡∏Ç‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô x5 ‡πÉ‡∏´‡πâ NPC +'+PRICES.sell.mat5+'G');
    }else if(kind==='coin1'){
      if(S.coins<1){ tip('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÇ‡∏ö‡∏£‡∏≤‡∏ì'); return; }
      S.coins-=1; S.gold+=PRICES.sell.coin1; tip('‡∏Ç‡∏≤‡∏¢‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÇ‡∏ö‡∏£‡∏≤‡∏ì x1 ‡πÉ‡∏´‡πâ NPC +'+PRICES.sell.coin1+'G');
    }else if(kind==='rare1'){
      if(S.rare<1){ tip('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•'); return; }
      S.rare-=1; S.gold+=PRICES.sell.rare1; tip('‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•‡∏´‡∏≤‡∏¢‡∏≤‡∏Å x1 ‡πÉ‡∏´‡πâ NPC +'+PRICES.sell.rare1+'G');
    }
    upd();
  }

  // ---- UI / STATE ----
  function upd(){
    ui.hp.textContent=S.baseHP; ui.gold.textContent=S.gold; ui.wave.textContent=S.wave;
    ui.mats.textContent=S.mats; ui.coins.textContent=S.coins; ui.rare.textContent=S.rare;
    renderMarket();
  }
  function gameOver(){ S.paused=true; S.running=false; tip('‡∏ê‡∏≤‡∏ô‡πÅ‡∏ï‡∏Å! ‡∏Å‡∏î ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï'); }

  // ---- WAVE: queue-based spawn (speed-aware) ----
  function startWave(){
    if(S.running){ tip('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ'); return; }
    S.running = true;
    tip('Wave '+S.wave);
    let pack=[];
    const n=S.wave;
    if(n%5===0){
      pack = Array(8).fill('runner').concat(Array(4).fill('brute')).concat(['boss']);
    } else {
      pack = Array(6+Math.floor(n*0.7)).fill('runner');
      if(n>2) pack = pack.concat(Array(Math.max(1,Math.floor(n/3))).fill('brute'));
      if(n>3) pack = pack.concat(Array(Math.max(1,Math.floor(n/4))).fill('flyer'));
    }
    S.spawnQ = pack.slice();
    S.spawnTimer = 0;
    S.spawnGap = Math.max(220, 520 - S.wave*18);
  }

  // ---- RENDER (Canvas) ----
  function drawGridAndPath(){
    // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    ctx.fillStyle = '#0a0f1a'; ctx.fillRect(0,0,W,H);
    // ‡∏ä‡πà‡∏≠‡∏á build
    ctx.save();
    for(let r=0;r<GRID.rows;r++){
      for(let c=0;c<GRID.cols;c++){
        const x=c*GRID.size+GRID.off, y=r*GRID.size+GRID.off;
        // ‡πÄ‡∏õ‡πá‡∏ô path?
        const onPath = PATH_RC.some(([rr,cc])=>rr===r&&cc===c);
        if(onPath){
          ctx.fillStyle='#0b1e34'; ctx.fillRect(x,y,GRID.size-2,GRID.size-2);
          ctx.strokeStyle='#10335d'; ctx.strokeRect(x+0.5,y+0.5,GRID.size-3,GRID.size-3);
        }else{
          ctx.fillStyle='#0c1424'; ctx.fillRect(x,y,GRID.size-2,GRID.size-2);
          ctx.setLineDash([4,4]); ctx.strokeStyle='#1f3861'; ctx.strokeRect(x+0.5,y+0.5,GRID.size-3,GRID.size-3);
          ctx.setLineDash([]);
        }
      }
    }
    ctx.restore();
    // Base
    ctx.save();
    ctx.fillStyle = '#1f2937'; ctx.strokeStyle='#94a3b8'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.roundRect(S.goal.x-21, S.goal.y-21, 42, 42, 10); ctx.fill(); ctx.stroke();
    ctx.restore();
  }
  function drawTowers(){
    for(const t of S.towers){
      ctx.save();
      ctx.translate(t.x, t.y);
      ctx.fillStyle=t.color; ctx.strokeStyle=(t.kind==='sniper'?'#075985':(t.kind==='frost'?'#155e75':'#0b3b2a'));
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.roundRect(-13,-13,26,26,6); ctx.fill(); ctx.stroke();
      ctx.restore();
    }
  }
  function drawEnemies(){
    for(const e of S.enemies){
      if(!e.alive) continue;
      ctx.save();
      ctx.translate(e.x, e.y);
      // body
      ctx.fillStyle=e.color; ctx.beginPath(); ctx.roundRect(0,0,20,20,6); ctx.fill();
      // HP bar
      const w=20, h=3, pct=clamp(e.hp/e.max,0,1);
      ctx.fillStyle='#111827'; ctx.fillRect(0,-6,w,h);
      ctx.fillStyle='#22c55e'; ctx.fillRect(0,-6,w*pct,h);
      ctx.restore();
    }
  }
  function drawBullets(){
    for(const b of S.bullets){
      if(b.dead) continue;
      ctx.save();
      ctx.fillStyle=b.color;
      ctx.beginPath(); ctx.arc(b.x,b.y,3,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
  }

  // ---- INPUT (tap to place/select) ----
  function screenToRC(x,y){
    const c=Math.floor((x-GRID.off)/GRID.size), r=Math.floor((y-GRID.off)/GRID.size);
    if(r<0||c<0||r>=GRID.rows||c>=GRID.cols) return null;
    return {r,c};
  }
  canvas.addEventListener('click', e=>{
    const rect=canvas.getBoundingClientRect();
    const x=e.clientX-rect.left, y=e.clientY-rect.top;
    const rc=screenToRC(x,y); if(!rc) return;
    if(S.mode==='place'){
      const k=$("selTower").value;
      placeTower(k, rc.r, rc.c);
      S.mode=null;
    }else{
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡πâ‡∏≠‡∏°‡∏´‡∏≤‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏°
      const tile=rc2xy(rc.r,rc.c);
      const found=S.towers.find(t=>Math.hypot(t.x-tile.x,t.y-tile.y)<GRID.size*0.4);
      if(found) selectTower(found); else selectTower(null);
    }
  }, {passive:true});
  canvas.addEventListener('touchstart', e=>{
    const t=e.touches[0]; const rect=canvas.getBoundingClientRect();
    const x=t.clientX-rect.left, y=t.clientY-rect.top;
    const rc=screenToRC(x,y); if(!rc) return;
    if(S.mode==='place'){
      const k=$("selTower").value;
      placeTower(k, rc.r, rc.c); S.mode=null;
    }else{
      const tile=rc2xy(rc.r,rc.c);
      const found=S.towers.find(t=>Math.hypot(t.x-tile.x,t.y-tile.y)<GRID.size*0.4);
      if(found) selectTower(found); else selectTower(null);
    }
  }, {passive:true});

  // ---- BUTTONS ----
  function bind(el,fn){ el.addEventListener('click',fn); el.addEventListener('touchstart',e=>{ e.preventDefault(); fn(); }, {passive:false}); }
  bind($("btnStart"), startWave);
  bind($("btnPause"), ()=>{ S.paused=!S.paused; $("btnPause").textContent=S.paused?'‚ñ∂ Resume':'‚è∏ Pause'; });
  bind($("btnSpeed"), ()=>{ S.speed=(S.speed===1?2:S.speed===2?3:1); $("btnSpeed").textContent='‚è© '+S.speed+'x'; });
  bind($("btnReset"), ()=>init(true));
  bind($("btnPlace"), ()=>{ S.mode='place'; tip('‡πÅ‡∏ï‡∏∞‡∏ä‡πà‡∏≠‡∏á Build ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏°'); });
  bind($("btnSell"), sellSelected);
  bind($("btnUpDmg"), ()=>upgradeSelected('dmg'));
  bind($("btnUpRng"), ()=>upgradeSelected('rng'));
  bind($("btnUpRof"), ()=>upgradeSelected('rof'));

  $("btnList").addEventListener('click',()=>{
    const type=$("sellItem").value; const price=Math.max(1, parseInt($("sellPrice").value||'0'));
    if(type==='mat'){
      if(S.mats<5){ tip('‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ (‚â•5)'); return; }
      S.mats-=5; S.listings.push({name:'‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô', qty:5, price});
    }else{
      if(S.rare<1){ tip('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•'); return; }
      S.rare-=1; S.listings.push({name:'‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡∏±‡∏•‡∏´‡∏≤‡∏¢‡∏≤‡∏Å', qty:1, price});
    }
    upd(); tip('‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
  });
  bind($("npcSellMat"), ()=>npcSell('mat5'));
  bind($("npcSellCoin"), ()=>npcSell('coin1'));
  bind($("npcSellRare"), ()=>npcSell('rare1'));

  // ---- INIT/LOOP ----
  function init(reset){
    if(reset){
      Object.assign(S,{
        baseHP:20,gold:180,wave:1,speed:1,running:false,paused:false,last:0,
        towers:[],enemies:[],bullets:[],mats:0,coins:0,rare:0,listings:[],
        selected:null,mode:null, spawnQ:[], spawnTimer:0, spawnGap:400
      });
    }
    buildMap(); upd(); selectTower(null);
  }

  function loop(ts){
    if(!S.last) S.last=ts;
    const dt=ts-S.last; S.last=ts;

    // --- SPAWN QUEUE (speed-aware) ---
    if(S.running && S.spawnQ.length){
      S.spawnTimer += dt * S.speed;
      while(S.spawnTimer >= S.spawnGap && S.spawnQ.length){
        spawnEnemy(S.spawnQ.shift());
        S.spawnTimer -= S.spawnGap;
      }
    }
    if(S.running && S.spawnQ.length===0 && S.enemies.length===0){
      S.running=false; S.wave++; S.gold+=24; upd(); tip('‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏ß‡∏ü +24G');
    }

    // --- UPDATE ---
    if(!S.paused){
      for(const e of S.enemies){ if(e.alive) enemyStep(e,dt); }
      for(const t of S.towers){ towerStep(t,dt); }
      for(const b of S.bullets){ if(!b.dead) bulletStep(b,dt); }
      S.enemies=S.enemies.filter(e=>e.alive);
      S.bullets=S.bullets.filter(b=>!b.dead);
    }

    // --- RENDER ---
    drawGridAndPath();
    drawTowers();
    drawEnemies();
    drawBullets();

    RAF(loop);
  }

  init(true); RAF(loop);

  // ===== AutoStart for iPhone attachment viewers =====
  function demo(){
    document.getElementById('overlay').style.display='none';
    // ‡∏ß‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏°‡∏ô‡∏≥‡∏£‡πà‡∏≠‡∏á
    placeTower('gun',3,2);
    placeTower('frost',5,6);
    setTimeout(startWave, 400);
  }
  window.addEventListener('pageshow', ()=> setTimeout(demo, 600), {once:true});
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ setTimeout(demo, 800); } }, {once:true});
  setTimeout(demo, 1200);
  const ovrBtn=$("ovrGo"); ovrBtn.addEventListener('click', demo); ovrBtn.addEventListener('touchstart',(e)=>{ e.preventDefault(); demo(); }, {passive:false});
})();
</script>
</body>
</html>
